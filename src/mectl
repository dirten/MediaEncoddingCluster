#!/bin/sh
#
#  File name:  S75mhive.system
#  Purpose:    Automatically starts MHiveSystemService on Linux/*nix when the
#              system starts
#  Author:     jan.hoelscher@esblab.com
#  Resides in: /etc/rc3.d
#

if [ ! -d /usr/bin ]
then                    # /usr not mounted
        exit
fi
prog="MHiveService"

#if [ $(id -u) != "0" ]
#then
#    echo "You must be root to run the configure script.  Login as root and then run the
#configure script."
#    exit 1
#fi

killproc() {            # kill the named process(es)
        pid=`/usr/bin/ps -e |
             /usr/bin/grep -w $1 |
             /usr/bin/sed -e 's/^  *//' -e 's/ .*//'`
        [ "$pid" != "" ] && kill $pid
}
unset COLUMNS
checkproc(){

    lsproc=$(ps xa |grep -E "$MHIVE_HOME"|grep -E $1 |grep -v grep|awk '{print $1}')

#    echo $lsproc
#    if [ -n $lsproc ]; then
#        return 0
#    fi
    return $lsproc
}

usage(){
        echo "Usage: $0 { start | stop | configure | status}"
}

status_runtime(){
	if checkproc "beam"; then
	    echo "Mhive Runtime is OFF"
#      action $"Running $prog" /bin/false
	else
	    echo "Mhive CLuster Runtime is ON"
#      action $"Running $prog" /bin/true
	fi
}

status_server(){
  false
}

status_client(){
  false
}

start_runtime(){
  action $"Starting $prog" /bin/true
  false
}

stop_runtime(){
  false
}

stop_runtime(){
  false
}

start_server(){
  RELDIR=$MHIVE_HOME/releases
  START_ERL_DATA=${1:-$RELDIR/start_erl.data}
  $MHIVE_HOME/bin/run_erl -daemon /tmp/ $MHIVE_HOME/logs "exec $MHIVE_HOME/bin/mectl start_erl $MHIVE_HOME $RELDIR $START_ERL_DATA"
  status_runtime
}

stop_server(){
  $BINDIR/erlexec -noshell -s mhive stopapp -s init stop
}

start_client(){
  false

}

stop_client(){
  false

}

configure(){
  $BINDIR/erlexec -noshell -mnesia dir "'${MHIVE_HOME}/${DATA_DIR}'" -s mhive configure -s init stop
}

configure_client(){
  false

}

# Start/stop processes required for MHive
 len=${#MHIVE_HOME}
  if [[ "$len" -lt "1" ]]
    then
      current_dir=`pwd`
      script_dir=`dirname $0`
      cd ${script_dir}/..
      MHIVE_HOME=`pwd`
  fi
DATA_DIR=data
ROOTDIR=${MHIVE_HOME}
BINDIR=$ROOTDIR/erts-5.6.5/bin
EMU=beam
PROGNAME=`echo $0 | sed 's/.*\///'`
export EMU
export ROOTDIR
export BINDIR
export PROGNAME
# always start the epmd

checkproc "epmd"
if [ $? -ne 0 ]; then
  ${MHIVE_HOME}/bin/epmd -daemon
fi

case "$1" in
    'start')
            # Start the MHive Runtime
            #
            start_server
            ;;
    'stop')
            stop_server
            ;;
    'configure')
            configure
            ;;
    'status')
            status_runtime
            ;;
    'start_erl')
        shift
        ROOTDIR=$1
        shift
        RELDIR=$1
        shift
        DataFile=$1
        shift

        ERTS_VSN=`awk '{print $1}' $DataFile`
        VSN=`awk '{print $2}' $DataFile`

        BINDIR=$ROOTDIR/erts-$ERTS_VSN/bin
        EMU=beam
        PROGNAME=`echo $0 | sed 's/.*\///'`
        export EMU
        export ROOTDIR
        export BINDIR
        export PROGNAME
        export RELDIR

        exec $BINDIR/erlexec -boot $RELDIR/$VSN/start -config $RELDIR/$VSN/sys ${1+"$@"} -mnesia dir "'${MHIVE_HOME}/${DATA_DIR}'"
            ;;
    *)
      usage
            ;;
esac

